<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onirix SDK with Scene Rotation and Pinch-to-Zoom</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <script type="module">
        import OnirixSDK from "https://unpkg.com/@onirix/ar-engine-sdk@1.6.5/dist/ox-sdk.esm.js";
        import * as THREE from "https://cdn.skypack.dev/three@0.136.0";
        import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js";

        class ARScene {
            constructor() {
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                this.controls = null;
                this.oxSDK = null;
            }

            async init() {
                try {
                    // Check for camera permissions
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    if (stream) {
                        // Initialize Onirix SDK with correct mode
                        this.oxSDK = new OnirixSDK("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjUyMDIsInByb2plY3RJZCI6MTQ0MjgsInJvbGUiOjMsImlhdCI6MTYxNjc1ODY5NX0.8F5eAPcBGaHzSSLuQAEgpdja9aEZ6Ca_Ll9wg84Rp5k");
                        const { canvas } = await this.oxSDK.init({ mode: OnirixSDK.TrackingMode.World });

                        this.setupRenderer(canvas);
                        this.setupScene();
                        this.setupControls();
                        this.addEventListeners();

                        // Subscribe to Onirix SDK events
                        this.oxSDK.subscribe(OnirixSDK.Events.OnFrame, () => {
                            this.render();
                        });

                        this.oxSDK.subscribe(OnirixSDK.Events.OnPose, (pose) => {
                            this.updatePose(pose);
                        });
                    }
                } catch (err) {
                    console.error("Error initializing ARScene", err);
                    alert("Failed to initialize AR. Please check your camera permissions and SDK configuration.");
                }
            }

            setupRenderer(canvas) {
                this.renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
            }

            setupScene() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.z = 5;

                // Add some basic geometry to visualize
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                this.scene.add(cube);
            }

            setupControls() {
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.25;
                this.controls.enableZoom = true;
                this.controls.zoomSpeed = 1.2;
            }

            addEventListeners() {
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            updatePose(pose) {
                this.camera.matrix.fromArray(pose);
                this.camera.matrixWorldNeedsUpdate = true;
                this.controls.update();
            }

            render() {
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const arScene = new ARScene();
            await arScene.init();
        });
    </script>
</body>
</html>
